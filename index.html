<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grok 이미지 생성</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 820px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin-bottom: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { margin-bottom: 14px; }
    label { font-weight: 600; display:block; margin-bottom: 6px; }
    input[type="text"] { width:100%; padding: 12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; }
    textarea { width:100%; padding:12px; border:1px solid #d1d5db; border-radius:10px; font-size:16px; }
    input[type="file"] { width:100%; }
    .btns { display:flex; gap:8px; flex-wrap:wrap; }
    button { flex: 1; min-width: 120px; padding: 12px 16px; font-size: 16px; border:0; border-radius: 12px; cursor:pointer; }
    button.primary { background:#111; color:#fff; }
    button.secondary { background:#f3f4f6; color:#111; }
    #result img, #result video { max-width: 100%; display: block; margin-top: 16px; border-radius: 12px; }
    .muted { color:#6b7280; font-size: 14px; }
    .preview { max-width: 240px; margin-top: 8px; border-radius: 8px; }
    .tabs { display:flex; gap:8px; margin-bottom:8px; }
    .tab { padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; cursor:pointer; }
    .tab.active { background:#111; color:#fff; border-color:#111; }
    .ok { color: #16a34a; font-weight: 600; }
    .err { color: #dc2626; font-weight: 600; }
  </style>
</head>
<body>
  <h1>Grok 이미지/영상 생성 데모</h1>

  <div class="card">
    <div class="row">
      <label>Cloud Run 서비스 URL</label>
      <input id="svcUrl" type="text" placeholder="예: https://my-service-abcdef.a.run.app" inputmode="url" />
      <div class="muted">한 번 저장하면 다음에 자동으로 불러옵니다.</div>
    </div>
    <div class="btns">
      <button id="saveUrl" class="secondary">주소 저장</button>
      <button id="testUrl" class="secondary">연결 테스트</button>
    </div>
    <div id="urlStatus" class="muted"></div>
  </div>

  <div class="card">
    <div class="tabs">
      <div class="tab active" data-mode="image">이미지 생성</div>
      <div class="tab" data-mode="video">영상 생성(이미지→영상)</div>
    </div>

    <div class="row">
      <label>프롬프트</label>
      <textarea id="prompt" rows="4" placeholder="원하는 장면을 자세히 적어주세요. 예) 햇살 들어오는 주방에서 팬케이크 굽는 고양이, 따뜻한 색감"></textarea>
    </div>

    <div class="row">
      <label>참고 이미지 (선택)</label>
      <input id="image" type="file" accept="image/*" />
      <div id="preview"></div>
      <div class="muted">영상(이미지→영상) 모드에서만 사용됩니다. 이미지 생성은 텍스트만 필요합니다.</div>
    </div>

    <div class="btns">
      <button id="gen" class="primary">생성하기</button>
      <span id="status" class="muted" style="align-self:center;"></span>
    </div>
  </div>

  <div id="result" class="card"></div>

  <script>
    // --- URL 저장/불러오기 ---
    const SVC_KEY = 'svcUrl';
    const $svcUrl = document.getElementById('svcUrl');
    const $saveUrl = document.getElementById('saveUrl');
    const $testUrl = document.getElementById('testUrl');
    const $urlStatus = document.getElementById('urlStatus');

    // UI 요소
    const $prompt = document.getElementById('prompt');
    const $image = document.getElementById('image');
    const $preview = document.getElementById('preview');
    const $btn = document.getElementById('gen');
    const $status = document.getElementById('status');
    const $result = document.getElementById('result');
    const $tabs = document.querySelectorAll('.tab');
    let mode = 'image';

    // 초기 로드 시 저장된 주소 복원
    const saved = localStorage.getItem(SVC_KEY);
    if (saved) $svcUrl.value = saved;

    // URL 정규화 (끝 슬래시 제거)
    function normUrl(u) {
      if (!u) return '';
      return u.replace(/\s+/g, '').replace(/\/+$/, '');
    }

    function getGenerateUrl() {
      const base = normUrl($svcUrl.value);
      if (!base) return null;
      return base + '/generate';
    }

    $saveUrl.addEventListener('click', () => {
      const base = normUrl($svcUrl.value);
      if (!/^https?:\/\/[^ ]+$/i.test(base)) {
        $urlStatus.innerHTML = '<span class="err">주소가 올바르지 않습니다.</span>';
        return;
      }
      localStorage.setItem(SVC_KEY, base);
      $svcUrl.value = base;
      $urlStatus.innerHTML = '<span class="ok">저장 완료</span>';
    });

    $testUrl.addEventListener('click', async () => {
      const base = normUrl($svcUrl.value);
      if (!base) {
        $urlStatus.innerHTML = '<span class="err">먼저 주소를 입력하세요.</span>';
        return;
      }
      $urlStatus.textContent = '연결 확인 중...';
      try {
        const r = await fetch(base + '/', { method: 'GET' });
        const t = await r.text().catch(() => '');
        if (r.ok && /OK/i.test(t)) {
          $urlStatus.innerHTML = '<span class="ok">연결 성공</span>';
          localStorage.setItem(SVC_KEY, base);
        } else {
          $urlStatus.innerHTML = `<span class="err">연결 실패 (HTTP ${r.status})</span>`;
        }
      } catch (e) {
        $urlStatus.innerHTML = `<span class="err">연결 실패: ${e?.message || e}</span>`;
      }
    });

    // 탭 전환
    $tabs.forEach(t => t.addEventListener('click', () => {
      $tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      mode = t.dataset.mode; // image | video
    }));

    // 이미지 프리뷰
    $image.addEventListener('change', async () => {
      $preview.innerHTML = '';
      const f = $image.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      const img = document.createElement('img');
      img.src = url;
      img.className = 'preview';
      $preview.appendChild(img);
    });

    // 파일 → base64
    async function fileToBase64(file) {
      const buf = await file.arrayBuffer();
      const bytes = new Uint8Array(buf);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }

    // 생성 버튼
    $btn.addEventListener('click', async () => {
      const genUrl = getGenerateUrl();
      if (!genUrl) {
        $urlStatus.innerHTML = '<span class="err">먼저 서비스 URL을 입력하고 저장하세요.</span>';
        return;
      }

      $status.textContent = '생성 중...';
      $result.innerHTML = '';
      $btn.disabled = true;

      try {
        let imagePayload = null;
        const f = $image.files?.[0];
        if (f) {
          imagePayload = { mime: f.type, base64: await fileToBase64(f) };
        }

        const payload = {
          mode, // 'image' | 'video'
          prompt: $prompt.value || '',
          image: imagePayload
        };

        const res = await fetch(genUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        const json = await res.json();
        if (!res.ok || json.error) throw new Error(json.error || `HTTP ${res.status}`);

        if (json.image_base64 && json.image_mime?.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = `data:${json.image_mime};base64,${json.image_base64}`;
          $result.appendChild(img);
        } else if (json.video_base64 && json.video_mime?.startsWith('video/')) {
          const video = document.createElement('video');
          video.controls = true;
          video.src = `data:${json.video_mime};base64,${json.video_base64}`;
          $result.appendChild(video);
        } else if (json.url) {
          const a = document.createElement('a');
          a.href = json.url;
          a.textContent = '결과 보기';
          a.target = '_blank';
          $result.appendChild(a);
        } else {
          $result.textContent = '생성 완료했지만 표시할 미디어가 없어요.';
        }

        $status.textContent = '완료!';
      } catch (err) {
        console.error(err);
        $status.textContent = '에러 발생';
        $result.innerHTML = `<div class="err">${String(err?.message || err)}</div>`;
      } finally {
        $btn.disabled = false;
      }
    });
  </script>
</body>
</html>
